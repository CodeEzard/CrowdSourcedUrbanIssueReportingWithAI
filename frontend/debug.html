<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - LocalStorage Inspector</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #667eea;
            border-radius: 4px;
        }
        .section h2 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 1.1em;
        }
        .key-value {
            display: flex;
            gap: 20px;
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }
        .key {
            font-weight: bold;
            color: #333;
            min-width: 150px;
        }
        .value {
            color: #666;
            word-break: break-all;
            max-width: 400px;
        }
        .jwt-payload {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            max-width: 600px;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.ok {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        button {
            padding: 10px 20px;
            margin: 10px 5px 0 0;
            border: none;
            border-radius: 4px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 1em;
        }
        button:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç LocalStorage Debug Inspector</h1>
        
        <div class="section">
            <h2>Authentication Status</h2>
            <div id="auth-status"></div>
        </div>

        <div class="section">
            <h2>LocalStorage Contents</h2>
            <div id="localStorage-contents"></div>
        </div>

        <div class="section">
            <h2>JWT Payload Analysis</h2>
            <div id="jwt-analysis"></div>
        </div>

        <div class="section">
            <h2>Actions</h2>
            <button onclick="clearStorage()">Clear All Storage</button>
            <button onclick="goToLogin()">Go to Login</button>
            <button onclick="goToAdmin()">Go to Admin Dashboard</button>
            <button onclick="location.reload()">Refresh Page</button>
        </div>
    </div>

    <script>
        function updateDebug() {
            // Auth Status
            const jwt = localStorage.getItem('jwt');
            const role = localStorage.getItem('uc_role');
            const user = localStorage.getItem('uc_user');

            const authDiv = document.getElementById('auth-status');
            authDiv.innerHTML = `
                <div class="key-value">
                    <span class="key">JWT Stored:</span>
                    <span class="value ${jwt ? 'status ok' : 'status error'}">${jwt ? '‚úì Yes' : '‚úó No'}</span>
                </div>
                <div class="key-value">
                    <span class="key">User:</span>
                    <span class="value">${user || '(not set)'}</span>
                </div>
                <div class="key-value">
                    <span class="key">Role:</span>
                    <span class="value ${role === 'admin' ? 'status ok' : 'status error'}">${role || '(not set)'}</span>
                </div>
                ${role === 'admin' ? '<div class="status ok">‚úì User is ADMIN - Can access admin dashboard</div>' : ''}
                ${role && role !== 'admin' ? '<div class="status error">‚úó User is ' + role.toUpperCase() + ' - Cannot access admin dashboard</div>' : ''}
                ${!role ? '<div class="status error">‚úó No role set - Must login as admin</div>' : ''}
            `;

            // LocalStorage Contents
            const localStorageDiv = document.getElementById('localStorage-contents');
            let html = '';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                const displayValue = key.includes('jwt') ? value.substring(0, 50) + '...' : value;
                html += `<div class="key-value">
                    <span class="key">${key}</span>
                    <span class="value">${displayValue}</span>
                </div>`;
            }
            if (localStorage.length === 0) {
                html = '<p><em>LocalStorage is empty</em></p>';
            }
            localStorageDiv.innerHTML = html;

            // JWT Analysis
            const jwtDiv = document.getElementById('jwt-analysis');
            if (jwt) {
                try {
                    const parts = jwt.split('.');
                    if (parts.length === 3) {
                        const payload = JSON.parse(atob(parts[1]));
                        jwtDiv.innerHTML = `
                            <p><strong>JWT Payload:</strong></p>
                            <div class="jwt-payload">
                                <pre>${JSON.stringify(payload, null, 2)}</pre>
                            </div>
                            ${payload.role ? `<div class="status ok">‚úì Role claim found: <strong>${payload.role}</strong></div>` : '<div class="status error">‚úó No role claim in JWT</div>'}
                            ${payload.user_id ? `<div class="key-value"><span class="key">User ID:</span><span class="value">${payload.user_id}</span></div>` : ''}
                            ${payload.exp ? `<div class="key-value"><span class="key">Expires:</span><span class="value">${new Date(payload.exp * 1000).toLocaleString()}</span></div>` : ''}
                        `;
                    } else {
                        jwtDiv.innerHTML = '<div class="status error">Invalid JWT format (not 3 parts)</div>';
                    }
                } catch (e) {
                    jwtDiv.innerHTML = `<div class="status error">Error parsing JWT: ${e.message}</div>`;
                }
            } else {
                jwtDiv.innerHTML = '<p><em>No JWT stored - User not logged in</em></p>';
            }
        }

        function clearStorage() {
            if (confirm('Clear all localStorage data?')) {
                localStorage.clear();
                updateDebug();
                alert('Storage cleared!');
            }
        }

        function goToLogin() {
            window.location.href = 'login2.html';
        }

        function goToAdmin() {
            if (localStorage.getItem('uc_role') !== 'admin') {
                alert('You are not logged in as admin.\n\nRole: ' + (localStorage.getItem('uc_role') || 'not set'));
                return;
            }
            window.location.href = 'admin-dashboard.html';
        }

        // Update on page load
        updateDebug();
        // Auto-update every 2 seconds
        setInterval(updateDebug, 2000);
    </script>
</body>
</html>
