<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard - Civic Issue</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body { background: #f5f5f5; }
    .admin-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; }
    .filter-bar button { padding: 8px 16px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; background: white; }
    .filter-bar button.active { background: #0f8f67; color: white; border-color: #0f8f67; }
    .issues-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 16px; }
    .issue-card { background: white; border-radius: 8px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .issue-card h3 { margin: 0 0 8px 0; }
    .issue-meta { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.9em; color: #666; }
    .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 600; }
    .status-open { background: #fff3cd; color: #856404; }
    .status-inprogress { background: #cfe2ff; color: #084298; }
    .status-closed { background: #d1e7dd; color: #0f5132; }
    .issue-actions { display: flex; gap: 8px; }
    .btn-small { padding: 6px 12px; font-size: 0.85em; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; }
    .btn-small:hover { background: #f9f9f9; }
    .btn-danger { color: #dc3545; border-color: #dc3545; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: white; border-radius: 8px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 24px; }
    .modal-close { position: absolute; top: 12px; right: 12px; border: none; background: none; cursor: pointer; font-size: 1.5em; }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>

  <main class="admin-container">
    <h1>Admin Dashboard</h1>
    
    <div class="filter-bar">
      <button class="filter-btn active" data-status="">All Issues</button>
      <button class="filter-btn" data-status="open">Open</button>
      <button class="filter-btn" data-status="inprogress">In Progress</button>
      <button class="filter-btn" data-status="closed">Closed</button>
    </div>

    <div class="issues-grid" id="issues-grid">
      <div style="text-align: center; width: 100%; grid-column: 1/-1;">Loading issues...</div>
    </div>
  </main>

  <!-- Issue Detail Modal -->
  <div id="issue-modal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close" id="modal-close" aria-label="Close">✕</button>
      <h2 id="modal-title"></h2>
      <div id="modal-body"></div>
      <div style="margin-top: 20px;">
        <label for="status-select">Status:</label>
        <select id="status-select">
          <option value="open">Open</option>
          <option value="inprogress">In Progress</option>
          <option value="closed">Closed</option>
        </select>
        <textarea id="admin-notes" placeholder="Add optional notes..." style="width: 100%; margin-top: 12px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 80px;"></textarea>
        <button id="update-btn" style="margin-top: 12px;" class="btn">Update Status</button>
      </div>
    </div>
  </div>

  <script>window.API_BASE = 'https://urban-civic-9oxw.onrender.com';</script>
  <script src="js/common.js"></script>
  <script>
    // Check if user is authenticated and is admin
    if (!localStorage.getItem('jwt')) {
      console.log('No JWT found');
      window.location.href = 'login2.html';
    }
    
    // Check if user has admin role
    const role = localStorage.getItem('uc_role');
    console.log('User role:', role);
    console.log('All localStorage keys:', Object.keys(localStorage));
    
    // Debug: Show what's in the JWT
    const jwt = localStorage.getItem('jwt');
    if (jwt) {
      try {
        const payload = JSON.parse(atob(jwt.split('.')[1]));
        console.log('JWT payload:', payload);
      } catch (e) {
        console.log('Could not parse JWT:', e);
      }
    }
    
    if (role !== 'admin') {
      console.log('User is not admin. Role is:', role);
      alert('You do not have admin access. Role: ' + (role || 'undefined'));
      window.location.href = 'profile.html';
    }

    let currentIssue = null;
    let currentFilter = '';

    // Load header
    fetch('includes/header.html')
      .then(r => r.text())
      .then(data => {
        qs('#header-placeholder').innerHTML = data;
        updateAuthUI(); // Ensure auth UI is updated after header is loaded
        qs('#nav-profile')?.classList.add('active');
        qs('nav')?.classList.add('active');
      });

    // Fetch and render issues
    async function loadIssues(status = '') {
      currentFilter = status;
      try {
        const url = `/api/admin/issues${status ? '?status=' + status : ''}`;
        const res = await apiFetch(url, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('jwt')}` },
          cache: 'no-store'
        });
        if (!res.ok) throw new Error('Failed to fetch issues');
        const posts = await res.json();
        renderIssues(posts || []);
      } catch (err) {
        qs('#issues-grid').innerHTML = `<div style="grid-column: 1/-1; color: red;">Error loading issues: ${err.message}</div>`;
      }
    }

    function renderIssues(posts) {
      qs('#issues-grid').innerHTML = posts.map(p => `
        <div class="issue-card">
          <h3>${p.issue?.name || 'Untitled'}</h3>
          <div class="issue-meta">
            <span>${p.issue?.category || '—'}</span>
            <span class="status-badge status-${p.status}">${p.status.toUpperCase()}</span>
          </div>
          <div style="font-size: 0.9em; color: #666; margin-bottom: 12px;">
            <div>By: ${p.user?.name || 'Unknown'}</div>
            <div>Created: ${new Date(p.created_at).toLocaleDateString()}</div>
            <div>Comments: ${(p.comments || []).length} | Upvotes: ${(p.upvotes || []).length}</div>
          </div>
          <div class="issue-actions">
            <button class="btn-small" onclick="showModal('${p.id}', '${p.status}')">View & Update</button>
          </div>
        </div>
      `).join('');
      
      if (posts.length === 0) {
        qs('#issues-grid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999;">No issues found.</div>';
      }
    }

    function showModal(issueId, status) {
      // Find the issue
      const res = apiFetch(`/api/admin/issues`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('jwt')}` },
        cache: 'no-store'
      });
      res.then(r => r.json()).then(posts => {
        const post = posts.find(p => p.id === issueId);
        if (!post) return;
        
        currentIssue = post;
        qs('#modal-title').textContent = post.issue?.name || 'Issue Detail';
        qs('#modal-body').innerHTML = `
          <div><strong>Category:</strong> ${post.issue?.category || '—'}</div>
          <div><strong>Description:</strong> ${post.description || '—'}</div>
          <div><strong>Location:</strong> ${post.lat}, ${post.lng}</div>
          <div style="margin-top: 12px;"><strong>Comments:</strong></div>
          <div style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 8px; border-radius: 4px;">
            ${(post.comments || []).map(c => `
              <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0;">
                <strong>${c.user?.name || 'User'}:</strong> ${c.content}
                <div style="font-size: 0.85em; color: #999;">${new Date(c.created_at).toLocaleString()}</div>
              </div>
            `).join('')}
          </div>
        `;
        qs('#status-select').value = status;
        qs('#admin-notes').value = '';
        qs('#issue-modal').classList.add('active');
      });
    }

    // Update status
    qs('#update-btn').addEventListener('click', async () => {
      if (!currentIssue) return;
      const newStatus = qs('#status-select').value;
      const notes = qs('#admin-notes').value.trim();
      
      try {
        const res = await apiFetch('/api/admin/post-status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('jwt')}`
          },
          body: JSON.stringify({ post_id: currentIssue.id, status: newStatus, notes })
        });
        if (!res.ok) throw new Error('Failed to update');
        showToast('Status updated!');
        qs('#issue-modal').classList.remove('active');
        loadIssues(currentFilter);
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    });

    // Close modal
    qs('#modal-close').addEventListener('click', () => {
      qs('#issue-modal').classList.remove('active');
    });

    // Filter buttons
    qsa('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        qsa('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadIssues(btn.dataset.status);
      });
    });

    // Initial load
    loadIssues();
    // Auto-refresh every 30s
    setInterval(() => loadIssues(currentFilter), 30000);
  </script>
</body>
</html>
