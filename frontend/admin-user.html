<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Urban Civic - Admin/User</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .profile-header {
      display: flex;
      align-items: center;
      gap: 20px;
      background: var(--card-bg, #f8fafc);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
      margin-bottom: 16px;
    }
    .profile-header:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .profile-pic {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: 3px solid var(--accent, #0d9488);
      object-fit: cover;
      background-color: #fff;
    }
    .profile-info {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .profile-info h2 {
      margin: 0;
      color: var(--text, #0f172a);
      font-size: 1.6rem;
      font-weight: 700;
    }
    .profile-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px 16px;
      margin-top: 6px;
      font-size: 0.9rem;
      color: #475569;
    }
    .profile-meta i {
      color: var(--accent, #0d9488);
      margin-right: 6px;
    }
  </style>

</head>
<body>
  <div id="header-placeholder"></div>

  <main id="app">
    <section id="view-profile" class="view active">
      <div class="grid">
        <div>
          <div class="card" id="profile-card">
            <h2 id="profile-title">Your Profile</h2>

            <!-- ðŸ’Ž Improved Profile Header -->
            <div class="profile-header">
              <img id="profile-pic" class="profile-pic" 
                   src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><circle cx='24' cy='24' r='24' fill='%23e6eef6'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23004d40'>U</text></svg>" 
                   alt="Profile picture">
              <div class="profile-info">
                <h2 id="profile-name">User Name</h2>
                <div id="profile-meta" class="profile-meta">
                  <div><i class="fa-solid fa-user-shield"></i> Role: <span id="meta-role"></span></div>
                  <div><i class="fa-solid fa-id-badge"></i> Username: <span id="meta-user"></span></div>
                  <div><i class="fa-solid fa-flag"></i> Reports: <span id="meta-reports"></span></div>
                  <div><i class="fa-solid fa-arrow-up"></i> Upvotes: <span id="meta-upvotes"></span></div>
                </div>
                <label for="profile-pic-upload" class="btn" style="margin-top:10px;width:max-content;">Change Picture</label>
                <input type="file" id="profile-pic-upload" accept="image/*" style="display:none">
              </div>
            </div>
            <!-- End Header -->

            <div id="profile-issues" class="list"></div>
          </div>
        </div>

        <aside>
          <div class="card">
            <h3>Quick Filters</h3>
            <div style="display:flex;flex-direction:column;gap:12px;margin-top:12px">
              <button class="btn" id="my-reports-btn">My Reports</button>
              <button class="btn secondary" id="upvoted-btn">Upvoted</button>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- Modal -->
    <div id="issue-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-content">
        <button class="modal-close" id="modal-close" aria-label="Close modal">âœ•</button>
        <h3 id="modal-title"></h3>
        <div id="modal-content"></div>
        <div class="comment-form">
          <label for="comment-input">Add a Comment</label>
          <textarea id="comment-input" aria-label="Add a comment"></textarea>
          <button class="btn" id="comment-submit" aria-label="Post comment">Post Comment</button>
        </div>
        <div class="comments" id="modal-comments"></div>
      </div>
    </div>
  </main>

  <!-- <footer>Built for your college project â€¢ Local storage backs demo data</footer> -->

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>window.API_BASE = 'https://urban-civic-9oxw.onrender.com';</script>
  <script src="js/common.js"></script>
  <script>
    fetch('includes/header.html')
      .then(response => response.text())
      .then(data => {
        qs('#header-placeholder').innerHTML = data;
        updateAuthUI(); // Ensure auth UI is updated after header is loaded
        initHeader();
      });

    function initHeader() {
      const nav = qs('nav');
      const menuToggle = qs('#menu-toggle');
      
      qs('#nav-profile').classList.add('active');
      if (nav) nav.classList.add('active');
      
      if (menuToggle) {
        menuToggle.addEventListener('click', () => {
          if (nav) nav.classList.toggle('active');
        });
      }
      
      qsa('nav a').forEach(link => {
        link.addEventListener('click', () => {
          if (nav) nav.classList.remove('active');
        });
      });
      
      qs('#role').value = role;
      qs('#role').addEventListener('change', e => {
        role = e.target.value;
        localStorage.setItem('uc_role', role);
        updateProfileLink();
        renderProfile(); // Re-render to reflect role change
      });
      qs('#theme-toggle').addEventListener('click', () => {
        document.body.dataset.theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('uc_theme', document.body.dataset.theme);
        qs('#theme-toggle').textContent = document.body.dataset.theme === 'dark' ? 'â˜€' : 'ðŸŒ™';
      });
      if (localStorage.getItem('uc_theme') === 'dark') {
        document.body.dataset.theme = 'dark';
        qs('#theme-toggle').textContent = 'â˜€';
      }
      updateProfileLink();
    }

    function updateProfileLink() {
      qs('#nav-profile').textContent = role === 'admin' ? 'Admin' : 'Profile';
    }

    function showModal(issue) {
      qs('#modal-title').textContent = issue.title;
      let modalContent = `
        <img src="${issue.photo || 'data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"400\" height=\"300\"><rect width=\"100%\" height=\"100%\" fill=\"%23f3f9f8\"/><text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"%23004d40\">No Image</text></svg>'}" alt="${issue.title}">
        <div><strong>Category:</strong> ${issue.category}</div>
        <div><strong>Location:</strong> ${issue.location}</div>
        <div><strong>Description:</strong> ${issue.desc}</div>
        <div><strong>Status:</strong> <span class="status ${issue.status}">${issue.status}</span></div>
        <div><strong>Votes:</strong> ${issue.votes}â–²</div>
        <div><strong>Reported by:</strong> ${issue.reporter}</div>
        ${issue.assignedAt ? `<div><strong>Assigned:</strong> ${new Date(issue.assignedAt).toLocaleString()}</div>` : ''}
      `;
      if (role === 'admin') {
        modalContent += `
          <div style="margin-top:16px">
            <label for="status-update">Update Status</label>
            <select id="status-update" aria-label="Update issue status">
              <option value="open" ${issue.status === 'open' ? 'selected' : ''}>Open</option>
              <option value="inprogress" ${issue.status === 'inprogress' ? 'selected' : ''}>In Progress</option>
              <option value="closed" ${issue.status === 'closed' ? 'selected' : ''}>Closed</option>
            </select>
            <button class="btn" id="assign-issue" style="margin-top:8px" data-id="${issue.id}">Assign Issue</button>
            <button class="btn" id="delete-issue" style="margin-top:8px" data-id="${issue.id}">Delete Issue</button>
          </div>
        `;
      }
      qs('#modal-content').innerHTML = modalContent;
      qs('#modal-comments').innerHTML = issue.comments.map(c => `<div class="comment"><strong>${c.user}:</strong> ${c.text} <span class="muted small">(${new Date(c.timestamp).toLocaleString()})</span></div>`).join('');
      qs('#issue-modal').style.display = 'flex';
      qs('#issue-modal').classList.add('active');
      qs('#comment-input').focus();
      qs('#comment-submit').dataset.issueId = issue.id;

      if (role === 'admin') {
        qs('#status-update')?.addEventListener('change', e => {
          const newStatus = e.target.value;
          issue.status = newStatus;
          saveData(issues);
          showToast(`Status updated to ${newStatus}!`);
          showModal(issue);
          renderProfile();
        });
        qs('#assign-issue')?.addEventListener('click', () => {
          issue.assignedAt = new Date().toISOString();
          saveData(issues);
          showToast('Issue assigned!');
          showModal(issue);
          renderProfile();
        });
        qs('#delete-issue')?.addEventListener('click', () => {
          lastDeletedIssue = issue;
          issues = issues.filter(i => i.id !== issue.id);
          saveData(issues);
          qs('#issue-modal').style.display = 'none';
          qs('#issue-modal').classList.remove('active');
          showToast('Issue deleted. <button class="btn undo-delete" style="margin-left:8px;padding:4px 8px">Undo</button>', 'error');
          renderProfile();
        });
      }
    }

    qs('#modal-close').addEventListener('click', () => {
      qs('#issue-modal').style.display = 'none';
      qs('#issue-modal').classList.remove('active');
      qs('#comment-input').value = '';
      delete qs('#comment-submit').dataset.issueId;
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && qs('#issue-modal').style.display === 'flex') {
        qs('#issue-modal').style.display = 'none';
        qs('#issue-modal').classList.remove('active');
        qs('#comment-input').value = '';
        delete qs('#comment-submit').dataset.issueId;
      }
    });

    qs('#comment-submit').addEventListener('click', async () => {
      const comment = qs('#comment-input').value.trim();
      const issueId = qs('#comment-submit').dataset.issueId;
      if (!comment || !issueId) return;
      try {
        const resp = await postComment(String(issueId), comment);
        const issue = issues.find(i => String(i.id) === String(issueId));
        if (issue) {
          issue.comments.push({ user: resp.user?.name || currentUser, text: resp.content || comment, timestamp: resp.created_at || new Date().toISOString() });
          showToast('Comment added!');
          showModal(issue);
        }
        qs('#comment-input').value = '';
      } catch (err) {
        console.warn('Failed to post comment:', err);
        showToast('Failed to add comment: ' + (err.message || ''), 'error');
      }
    });
    qs('#profile-name').textContent = currentUser;
    function renderProfile() {
      qs('#profile-title').textContent = role === 'admin' ? 'Admin Dashboard' : 'Your Profile';
      qs('#profile-pic').src = profilePic;
      qs('#meta-role').textContent = role;
      qs('#meta-user').textContent = currentUser;
      qs('#meta-reports').textContent = issues.filter(i => i.reporter === currentUser).length;
      qs('#meta-upvotes').textContent = Object.keys(upvotes).filter(k => k.startsWith(currentUser)).length;
      
      // Set quick filters based on role
      const filters = qs('#quick-filters');
      filters.innerHTML = role === 'admin' 
        ? `
            <button class="btn" id="all-issues-btn">All Issues</button>
            <button class="btn secondary" id="open-issues-btn">Open Issues</button>
            <button class="btn secondary" id="assigned-issues-btn">Assigned Issues</button>
          `
        : `
            <button class="btn" id="my-reports-btn">My Reports</button>
            <button class="btn secondary" id="upvoted-btn">Upvoted</button>
          `;

      // Render issues based on role
      const el = qs('#profile-issues');
      el.innerHTML = '';
      let list = role === 'admin' ? issues : issues.filter(i => i.reporter === currentUser);
      if (list.length === 0) {
        el.innerHTML = `<div class="muted">${role === 'admin' ? 'No issues reported yet.' : 'You have not reported anything yet.'}</div>`;
      }
      list.forEach(it => {
        const d = document.createElement('div');
        d.className = 'issue';
        let actions = '';
        if (role === 'admin') {
          actions = `
            <button class="btn" data-open="${it.id}" aria-label="View and manage issue ${it.title}">Manage</button>
          `;
        } else if (it.reporter === currentUser) {
          actions = `
            <button class="btn" data-delete="${it.id}" aria-label="Delete issue ${it.title}">Delete</button>
            <button class="btn" data-open="${it.id}" aria-label="View details for ${it.title}">View Details</button>
          `;
        } else {
          actions = `
            <button class="btn" data-open="${it.id}" aria-label="View details for ${it.title}">View Details</button>
          `;
        }
        d.innerHTML = `
          <img loading="lazy" src="${it.photo || 'data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"400\" height=\"300\"><rect width=\"100%\" height=\"100%\" fill=\"%23f7fbfa\"/><text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"%23004d40\">No Image</text></svg>'}" alt="${it.title}">
          <div class="meta">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700"><span class="category-icon">${getCategoryIcon(it.category)}</span>${it.title}</div>
              <div class="muted small">${it.votes}â–²</div>
            </div>
            <div class="muted small">${it.category} â€¢ ${it.location}</div>
            <div class="muted small">${it.assignedAt ? `Assigned: ${new Date(it.assignedAt).toLocaleString()}` : ''}</div>
            <div style="margin-top:12px">${actions}</div>
          </div>`;
        el.appendChild(d);
      });
      observeIssues(el);

      // Add event listeners for filters
      if (role === 'admin') {
        qs('#all-issues-btn').addEventListener('click', () => {
          list = issues;
          renderIssues(list);
        });
        qs('#open-issues-btn').addEventListener('click', () => {
          list = issues.filter(i => i.status === 'open');
          renderIssues(list);
        });
        qs('#assigned-issues-btn').addEventListener('click', () => {
          list = issues.filter(i => i.assignedAt);
          renderIssues(list);
        });
      } else {
        qs('#my-reports-btn').addEventListener('click', () => {
          list = issues.filter(i => i.reporter === currentUser);
          renderIssues(list);
        });
        qs('#upvoted-btn').addEventListener('click', () => {
          list = issues.filter(issue => upvotes[`${currentUser}_${issue.id}`]);
          renderIssues(list);
        });
      }
    }

    function renderIssues(list) {
      const el = qs('#profile-issues');
      el.innerHTML = '';
      if (list.length === 0) {
        el.innerHTML = `<div class="muted">${role === 'admin' ? 'No issues match the filter.' : 'No issues found.'}</div>`;
        return;
      }
      list.forEach(it => {
        const d = document.createElement('div');
        d.className = 'issue';
        let actions = '';
        if (role === 'admin') {
          actions = `
            <button class="btn" data-open="${it.id}" aria-label="View and manage issue ${it.title}">Manage</button>
          `;
        } else if (it.reporter === currentUser) {
          actions = `
            <button class="btn" data-delete="${it.id}" aria-label="Delete issue ${it.title}">Delete</button>
            <button class="btn" data-open="${it.id}" aria-label="View details for ${it.title}">View Details</button>
          `;
        } else {
          actions = `
            <button class="btn" data-open="${it.id}" aria-label="View details for ${it.title}">View Details</button>
          `;
        }
        d.innerHTML = `
          <img loading="lazy" src="${it.photo || 'data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"400\" height=\"300\"><rect width=\"100%\" height=\"100%\" fill=\"%23f7fbfa\"/><text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"%23004d40\">No Image</text></svg>'}" alt="${it.title}">
          <div class="meta">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700"><span class="category-icon">${getCategoryIcon(it.category)}</span>${it.title}</div>
              <div class="muted small">${it.votes}â–²</div>
            </div>
            <div class="muted small">${it.category} â€¢ ${it.location}</div>
            <div class="muted small">${it.assignedAt ? `Assigned: ${new Date(it.assignedAt).toLocaleString()}` : ''}</div>
            <div style="margin-top:12px">${actions}</div>
          </div>
        `;
        el.appendChild(d);
      });
      observeIssues(el);
    }

    qs('#profile-pic-upload').addEventListener('change', e => {
      const f = e.target.files[0];
      if (!f || !f.type.startsWith('image/')) {
        showToast('Please select a valid image file.', 'error');
        return;
      }
      const reader = new FileReader();
      reader.onload = ev => {
        profilePic = ev.target.result;
        localStorage.setItem('uc_profile_pic', profilePic);
        qs('#profile-pic').src = profilePic;
        showToast('Profile picture updated!');
      };
      reader.onerror = () => showToast('Failed to read image file.', 'error');
      reader.readAsDataURL(f);
    });

    document.addEventListener('click', e => {
      const deleteBtn = e.target.closest('[data-delete]');
      const openBtn = e.target.closest('[data-open]');
      const undoBtn = e.target.closest('.undo-delete');
      if (deleteBtn) {
        const id = deleteBtn.getAttribute('data-delete');
        lastDeletedIssue = issues.find(i => String(i.id) === String(id));
        issues = issues.filter(i => String(i.id) !== String(id));
        showToast('Report deleted. <button class="btn undo-delete" style="margin-left:8px;padding:4px 8px">Undo</button>', 'error');
        renderProfile();
      }
      if (openBtn) {
        const id = openBtn.getAttribute('data-open');
        const issue = issues.find(i => String(i.id) === String(id));
        if (issue) showModal(issue);
      }
      if (undoBtn && lastDeletedIssue) {
        issues.push(lastDeletedIssue);
        showToast('Report restored!');
        lastDeletedIssue = null;
        renderProfile();
      }
    });

    renderProfile();
  </script>
</body>
</html>